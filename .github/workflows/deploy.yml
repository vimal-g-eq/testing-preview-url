name: Deploy React App to GitHub Pages

on:
  push:
    branches:
      - master  # Deploy only when the 'master' branch is updated (after merge)
  pull_request:
    branches:
      - master  # For preview when a PR is targeting 'master'

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Grant write permission to push to the repository

    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'  # Use your desired Node.js version

      # Install dependencies
      - name: Install dependencies
        run: npm install

      # Build the React app
      - name: Build the app
        run: npm run build

      # Deploy to GitHub Pages (for master branch deployment)
      - name: Deploy to GitHub Pages (live)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'  # Only deploy when merged into master
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build  # The directory containing your built React app
          publish_branch: gh-pages  # Deploy to 'gh-pages' branch for live site

      # Deploy preview for PR (for preview branch deployment)
      - name: Deploy preview for PR
        if: github.event_name == 'pull_request'  # For pull request event
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build  # Deploy the build to a subfolder within gh-pages
          publish_branch: gh-pages  # Deploy to 'gh-pages' branch for PR preview
          user_name: 'GitHub Actions'
          user_email: 'vimal.gandhi@equestsolutions.net'
          publish_dir: ./build  # Ensure the preview is placed in a subfolder
          target_dir: preview  # Specify the preview subfolder

      # Output the deployed URLs (for PR preview and master deployment)
      - name: Display deployed URLs
        run: |
          if [[ $GITHUB_REF == "refs/heads/master" ]]; then
            echo "Your live app is available at https://vimal-g-eq.github.io/testing-preview-url/"
          else
            echo "Preview is available at https://vimal-g-eq.github.io/testing-preview-url/preview/"
          fi
